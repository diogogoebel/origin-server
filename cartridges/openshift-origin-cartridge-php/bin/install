#!/bin/bash -eu

case "$1" in
  -v|--version)
    version="$2"
esac

echo "$version" > "$OPENSHIFT_PHP_DIR/env/OPENSHIFT_PHP_VERSION"
echo "$OPENSHIFT_PHP_DIR/configuration/etc/php.ini" > "$OPENSHIFT_PHP_DIR/env/PHPRC"

rm -f $OPENSHIFT_PHP_DIR/modules $OPENSHIFT_PHP_DIR/conf/magic
ln -s /usr/lib64/httpd/modules $OPENSHIFT_PHP_DIR/modules
ln -s /etc/httpd/conf/magic $OPENSHIFT_PHP_DIR/conf/magic

# Pear setup

if [ $version == "5.3" ]; then
	rm -f $OPENSHIFT_HOMEDIR/.pearrc
	pear config-create "$OPENSHIFT_PHP_DIR"/phplib/pear/ "$OPENSHIFT_HOMEDIR"/.pearrc
	pear -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set php_ini "$OPENSHIFT_PHP_DIR"/configuration/etc/php.ini
	pear -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set auto_discover 1

elif [ $version == "5.4" ]; then

	rm -f $OPENSHIFT_HOMEDIR/.pearrc
	scl enable php54 "pear config-create '$OPENSHIFT_PHP_DIR'/phplib/pear/ '$OPENSHIFT_HOMEDIR'/.pearrc"
	scl enable php54 "pear -c '$OPENSHIFT_HOMEDIR'/.pearrc config-set php_ini '$OPENSHIFT_PHP_DIR'/configuration/etc/php.ini"
	scl enable php54 "pear -c '$OPENSHIFT_HOMEDIR'/.pearrc config-set auto_discover 1"

else 
	rm -f $OPENSHIFT_HOMEDIR/.pearrc
	scl enable php55 "pear config-create '$OPENSHIFT_PHP_DIR'/phplib/pear/ '$OPENSHIFT_HOMEDIR'/.pearrc"
	scl enable php55 "pear -c '$OPENSHIFT_HOMEDIR'/.pearrc config-set php_ini '$OPENSHIFT_PHP_DIR'/configuration/etc/php.ini"
	scl enable php55 "pear -c '$OPENSHIFT_HOMEDIR'/.pearrc config-set auto_discover 1"
fi



#Php env
if [ $version == "5.4" ]; then
	dirname $(scl enable php54 "which php") >>$OPENSHIFT_PHP_DIR/env/OPENSHIFT_PHP_PATH_ELEMENT
elif [ $version == "5.5" ]; then
	dirname $(scl enable php55 "which php") >>$OPENSHIFT_PHP_DIR/env/OPENSHIFT_PHP_PATH_ELEMENT
fi
